<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NetMarket OS - TITAN V8 Hybrid (Workflow Suite) ‚Äî PRO</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#d4af37; --primary-dim: rgba(212,175,55,.15);
      --bg-deep:#0b0c10; --bg-sidebar:#111418; --bg-panel:#1a1d21;
      --border:#2d3238; --text-main:#e0e6ed; --text-muted:#949ba3;
      --success:#51cf66; --danger:#ff6b6b; --info:#4dabf7; --warn:#ffd43b;
      --font-ui:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --node-bg:#151a20;
      --node-stroke:#2b3138;
      --node-text:#d6dde6;
      --grid: rgba(255,255,255,.05);
      --glass: rgba(15,18,22,.65);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg-deep);color:var(--text-main);font-family:var(--font-ui);height:100vh;display:flex;overflow:hidden}

    /* LAYOUT */
    .sidebar{width:270px;background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:10;padding:10px}
    .main-wrapper{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
    .top-bar{height:60px;border-bottom:1px solid var(--border);background:var(--bg-sidebar);display:flex;align-items:center;justify-content:space-between;padding:0 22px}
    .content-area{flex:1;overflow-y:auto;padding:26px}

    /* COMPONENTS */
    .brand{padding:15px;font-family:'Playfair Display',serif;font-size:1.4rem;color:#fff;display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .brand i{color:var(--primary)}
    .nav-label{font-size:.7rem;text-transform:uppercase;color:var(--text-muted);font-weight:700;margin:15px 0 6px 10px}
    .nav-item{padding:10px 15px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:.92rem;color:var(--text-muted);margin-bottom:4px;transition:.2s}
    .nav-item:hover,.nav-item.active{background:var(--primary-dim);color:var(--primary);border-left:3px solid var(--primary)}
    .grid-4{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:16px}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:16px;margin-bottom:16px}
    .card{background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;box-shadow:var(--shadow)}
    .card h3{margin-bottom:12px}
    .stat-val{font-size:2rem;font-weight:800;color:#fff;font-family:var(--font-code);margin:10px 0}
    .muted{color:var(--text-muted)}
    .mono{font-family:var(--font-code)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid var(--border);font-size:.78rem;color:#cbd5e1;background:#0f1216}
    .pill.ok{border-color:rgba(81,207,102,.35);color:var(--success)}
    .pill.bad{border-color:rgba(255,107,107,.35);color:var(--danger)}
    .pill.info{border-color:rgba(77,171,247,.35);color:var(--info)}
    .pill.warn{border-color:rgba(255,212,59,.35);color:var(--warn)}
    .btn{background:var(--primary);color:#000;border:none;padding:9px 14px;border-radius:9px;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:#fff}
    .btn.secondary{background:transparent;color:var(--text-main);border:1px solid var(--border);font-weight:650}
    .btn.secondary:hover{border-color:rgba(212,175,55,.5);color:var(--primary)}
    .btn.danger{background:transparent;border:1px solid rgba(255,107,107,.45);color:var(--danger)}
    .btn.danger:hover{background:rgba(255,107,107,.1)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .toolbar-left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar-right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input,.select{
      background:#0f1216;border:1px solid var(--border);color:var(--text-main);
      padding:9px 10px;border-radius:10px;outline:none
    }
    .input{min-width:240px}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .hint{font-size:.82rem;color:#aeb6bf}

    /* TABLE */
    .data-table{width:100%;border-collapse:collapse;margin-top:8px}
    .data-table th{text-align:left;padding:10px;color:var(--text-muted);border-bottom:1px solid var(--border);font-size:.78rem}
    .data-table td{padding:10px;border-bottom:1px solid #333;color:#d1d5db;font-size:.88rem}
    .td-right{text-align:right}
    .empty{padding:18px;color:#777;text-align:center;border:1px dashed #2c3036;border-radius:12px;background:#0f1216}

    /* VIEW SECTIONS */
    .view-section{display:none;animation:fadeIn .28s}
    .view-section.active{display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* TOASTS */
    .toasts{position:fixed;bottom:16px;right:16px;z-index:5000;display:flex;flex-direction:column;gap:10px}
    .toast{
      width:min(440px, calc(100vw - 32px));
      background:#0f1216;border:1px solid var(--border);border-left:4px solid var(--info);
      border-radius:12px;padding:12px 12px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:flex-start
    }
    .toast.ok{border-left-color:var(--success)}
    .toast.bad{border-left-color:var(--danger)}
    .toast.warn{border-left-color:var(--warn)}
    .toast .t-title{font-weight:900;margin-bottom:2px}
    .toast .t-msg{color:#cbd5e1;font-size:.9rem}
    .toast .t-close{margin-left:auto;background:transparent;border:none;color:#cbd5e1;cursor:pointer;font-size:1.1rem}
    .toast .t-close:hover{color:#fff}

    /* =========================================================
       WORKFLOW STUDIO ‚Äî PRO
       - "Viewport" = pan/zoom + fit + fullscreen
       - "World" = large area containing nodes OR screenshot
    ========================================================= */
    .wf-wrap{display:grid;grid-template-columns: 1.35fr .65fr;gap:16px}
    @media(max-width:1050px){.wf-wrap{grid-template-columns:1fr}}

    /* View mode tabs */
    .wf-tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      background:#0f1216;border:1px solid var(--border);
      color:#cbd5e1;border-radius:999px;padding:7px 12px;font-weight:800;
      cursor:pointer;font-size:.82rem;
    }
    .tab.active{border-color:rgba(212,175,55,.6);color:var(--primary);background:rgba(212,175,55,.12)}
    .tab i{margin-right:6px}

    /* Studio container */
    .wf-studio{
      border-radius:14px;border:1px solid var(--border);
      background:#0f1216;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      height:620px; /* plus haut, plus lisible */
    }

    /* top overlay controls */
    .wf-controls{
      position:absolute;top:10px;left:10px;right:10px;z-index:30;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      pointer-events:none;
    }
    .wf-controls .left, .wf-controls .right{display:flex;gap:8px;flex-wrap:wrap;pointer-events:auto}
    .wf-controls .chip{
      background:var(--glass);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
      padding:7px 10px;border-radius:999px;font-size:.8rem;color:#dbe2ea;
      display:inline-flex;gap:8px;align-items:center;
    }
    .wf-controls .iconbtn{
      width:36px;height:36px;border-radius:10px;
      background:rgba(15,18,22,.8);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;color:#dbe2ea;
      display:flex;align-items:center;justify-content:center;
    }
    .wf-controls .iconbtn:hover{border-color:rgba(212,175,55,.5);color:var(--primary)}
    .wf-controls .zoomval{min-width:72px;justify-content:center;font-family:var(--font-code)}

    /* Viewport (pan/zoom surface) */
    .wf-viewport{
      position:absolute;inset:0;
      background:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px),
        #0f1216;
      background-size: 28px 28px;
      overflow:hidden;
      cursor:grab;
    }
    .wf-viewport.grabbing{cursor:grabbing}
    .wf-world{
      position:absolute;
      left:0;top:0;
      width:2200px;   /* surface large pour voir tout */
      height:1400px;  /* surface large pour voir tout */
      transform-origin: 0 0;
    }

    /* SVG for edges (inside world) */
    .wf-svg{position:absolute;inset:0;pointer-events:none}

    /* Nodes layer */
    .wf-nodes{position:absolute;inset:0}

    .node{
      position:absolute;min-width:190px;max-width:240px;
      background:var(--node-bg);
      border:1px solid var(--node-stroke);
      border-radius:12px;
      padding:10px 10px;
      display:flex;gap:10px;align-items:flex-start;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      cursor:grab;
      user-select:none;
      transition:.18s;
    }
    .node .ic{
      width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background:#0f1216;border:1px solid #2a2f35;color:#cbd5e1;
      flex:0 0 34px;
    }
    .node .t{
      display:flex;flex-direction:column;gap:2px;
      color:var(--node-text);
      min-width:0;
    }
    .node .t .title{font-weight:900;font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .node .t .sub{font-size:.76rem;color:#9aa3ad;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .node .badge{
      margin-left:auto;
      font-size:.72rem;
      padding:4px 8px;border-radius:999px;border:1px solid #2a2f35;color:#cbd5e1;background:#0f1216;
      align-self:flex-start;
    }
    .node.active{transform:scale(1.02);border-color:rgba(212,175,55,.7);box-shadow: 0 0 0 2px rgba(212,175,55,.25), 0 10px 26px rgba(0,0,0,.45)}
    .node.ok{border-color:rgba(81,207,102,.55)}
    .node.warn{border-color:rgba(255,212,59,.55)}
    .node.fail{border-color:rgba(255,107,107,.65)}
    .node .badge.ok{color:var(--success);border-color:rgba(81,207,102,.35)}
    .node .badge.warn{color:var(--warn);border-color:rgba(255,212,59,.35)}
    .node .badge.fail{color:var(--danger);border-color:rgba(255,107,107,.35)}
    .node .badge.idle{color:#9aa3ad}

    /* Screenshot view in world */
    .wf-shot{
      position:absolute;left:80px;top:80px;
      width:1800px; /* grand pour pr√©senter */
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b0c10;
      overflow:hidden;
      box-shadow: 0 12px 28px rgba(0,0,0,.5);
    }
    .wf-shot header{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      background:rgba(15,18,22,.9);
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:.85rem;
      color:#dbe2ea;
    }
    .wf-shot header .left{display:flex;align-items:center;gap:10px}
    .wf-shot header .left span{color:var(--primary);font-weight:900}
    .wf-shot .body{padding:12px}
    .wf-shot img{
      max-width:100%;
      width:100%;
      height:auto;
      display:block;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      background:#000;
    }
    .wf-shot .placeholder{
      padding:26px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:10px;
      color:#8d97a3;
      text-align:center;
      background:rgba(0,0,0,.25);
    }

    /* Right panel */
    .wf-panel{display:flex;flex-direction:column;gap:14px}
    .wf-panel .card{height:100%}
    .wf-mini{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .wf-mini .mini{
      background:#0f1216;border:1px solid var(--border);border-radius:12px;padding:12px;
    }
    .wf-mini .mini .k{color:#9aa3ad;font-size:.78rem}
    .wf-mini .mini .v{margin-top:6px;color:#fff;font-weight:900;font-family:var(--font-code);font-size:1.1rem}

    .wf-term{
      background:#050505;border:1px solid #222;border-radius:12px;padding:12px;height:210px;overflow:auto;
      font-family:var(--font-code);font-size:.82rem;color:#33ff00;
    }
    .term-line{margin-bottom:6px;opacity:0;animation:slideIn .18s forwards;display:flex;gap:10px}
    .term-time{color:#555;white-space:nowrap}
    .term-text{color:#ddd}
    @keyframes slideIn{from{transform:translateX(10px);opacity:0}to{transform:translateX(0);opacity:1}}

    /* LOGS + AUDIT */
    .split{display:grid;grid-template-columns: 1.15fr .85fr;gap:16px}
    @media(max-width:1050px){.split{grid-template-columns:1fr}}

    /* Fullscreen modal */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.68);
      display:none;align-items:center;justify-content:center;z-index:6000;
      padding:18px;
    }
    .modal.active{display:flex}
    .modal .box{
      width:min(1400px, 98vw);
      height:min(860px, 92vh);
      background:#0f1216;border:1px solid rgba(255,255,255,.12);
      border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.7);
      display:flex;flex-direction:column;
    }
    .modal .box .bar{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;background:#0b0c10;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal .box .bar .title{font-weight:900;color:#fff}
    .modal .box .bar .actions{display:flex;gap:8px}
    .modal .box .content{flex:1;position:relative}
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-cube"></i> NetMarket
      <span style="font-size:.62rem;border:1px solid var(--primary);padding:2px 6px;border-radius:8px;margin-left:5px;">TITAN V8 PRO</span>
    </div>

    <div class="nav-label">G√©n√©ral</div>
    <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</div>

    <div class="nav-label">Outils M√©tiers</div>
    <div class="nav-item" onclick="nav('design', this)"><i class="fas fa-pencil-ruler"></i> NetDesignX</div>
    <div class="nav-item" onclick="nav('cat', this)"><i class="fas fa-tags"></i> NetCatX</div>
    <div class="nav-item" onclick="nav('promo', this)"><i class="fas fa-bullhorn"></i> NetMarkX</div>
    <div class="nav-item" onclick="nav('care', this)"><i class="fas fa-headset"></i> NetCareX</div>

    <div class="nav-label">Ops</div>
    <div class="nav-item" onclick="nav('ops', this)"><i class="fas fa-shield-halved"></i> Audit & Conformit√©</div>

    <div style="margin-top:auto;font-size:.78rem;color:#555;padding:10px;">
      System Status: <span style="color:var(--success)">‚óè Online</span><br>
      Server: AWS-Paris-1<br>
      Build: <span class="mono">titan-v8.workflow-suite.pro</span>
    </div>
  </aside>

  <div class="main-wrapper">
    <header class="top-bar">
      <div style="font-weight:900" id="pageTitle">Dashboard</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:.85rem;color:var(--text-muted);" id="clock">--:--:--</span>
        <span class="pill info"><i class="fas fa-bolt"></i> D√©mo (n8n-like)</span>
        <span class="pill warn"><i class="fas fa-computer-mouse"></i> Zoom: molette | Pan: drag</span>
        <span style="font-size:.85rem;color:var(--text-muted);">Admin User</span>
        <div style="width:30px;height:30px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#000;font-weight:900;">A</div>
      </div>
    </header>

    <div class="content-area">

      <!-- DASHBOARD -->
      <section id="dashboard" class="view-section active">
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="pill ok"><i class="fas fa-heart-pulse"></i> Uptime 99.98%</span>
            <span class="pill info"><i class="fas fa-arrows-rotate"></i> Sync 2m</span>
            <span class="pill warn"><i class="fas fa-triangle-exclamation"></i> 1 alerte</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="exportLogsCSV()"><i class="fas fa-file-export"></i> Export Logs</button>
            <button class="btn" onclick="toast('ok','Snapshot','Rapport KPI g√©n√©r√© (d√©mo).')"><i class="fas fa-camera"></i> Snapshot</button>
          </div>
        </div>

        <h2 style="margin-bottom:14px;color:#fff;">Vue d'Ensemble</h2>

        <div class="grid-4">
          <div class="card">
            <div class="muted">Chiffre d'Affaires</div>
            <div class="stat-val" id="kpiCA">11.1 Mds</div>
            <div style="color:var(--success);font-size:.82rem;">‚ñ≤ +7% Annuel</div>
          </div>
          <div class="card">
            <div class="muted">Visiteurs Actifs</div>
            <div class="stat-val" id="kpiVisitors">45,200</div>
            <div style="color:var(--success);font-size:.82rem;">‚ñ≤ +12% vs Hier</div>
          </div>
          <div class="card">
            <div class="muted">Commandes / Jour</div>
            <div class="stat-val" id="kpiOrders">8,450</div>
            <div style="color:var(--info);font-size:.82rem;">‚óè Stable</div>
          </div>
          <div class="card">
            <div class="muted">Taux Retour</div>
            <div class="stat-val" id="kpiReturns">14%</div>
            <div style="color:var(--danger);font-size:.82rem;">‚ñº -2% (Objectif)</div>
          </div>
        </div>

        <!-- More charts: pro KPI storytelling -->
        <div class="grid-2">
          <div class="card" style="height:320px;">
            <h3>Time-to-Market (Design ‚Üí Live)</h3>
            <div class="hint">Objectif : r√©duire le lead time et stabiliser les pics.</div>
            <div style="height:240px;margin-top:10px"><canvas id="chartTTM"></canvas></div>
          </div>
          <div class="card" style="height:320px;">
            <h3>Data Quality PIM (erreurs / 1000 SKU)</h3>
            <div class="hint">Objectif : tendre vers 0.5 / 1000 et limiter les doublons.</div>
            <div style="height:240px;margin-top:10px"><canvas id="chartDQ"></canvas></div>
          </div>
          <div class="card" style="height:320px;">
            <h3>Marketing ‚Äî ROI / ROAS (7j)</h3>
            <div class="hint">Objectif : arbitrage budget par performance.</div>
            <div style="height:240px;margin-top:10px"><canvas id="chartROI"></canvas></div>
          </div>
          <div class="card" style="height:320px;">
            <h3>Support ‚Äî SLA, FRT, TTR</h3>
            <div class="hint">Objectif : r√©duire le d√©lai, pas l‚Äôhumain (sinon √ßa se voit).</div>
            <div style="height:240px;margin-top:10px"><canvas id="chartSLA"></canvas></div>
          </div>
        </div>

        <div class="split">
          <div class="card">
            <div class="toolbar" style="margin-bottom:6px;">
              <div class="toolbar-left">
                <h3 style="margin:0;">Flux d'Activit√© (Logs)</h3>
                <span class="pill info"><i class="fas fa-database"></i> Event Stream</span>
              </div>
              <div class="toolbar-right">
                <input class="input" id="logSearch" placeholder="Rechercher: module, action, d√©tail..." oninput="renderLogs()" />
                <select class="select" id="logFilter" onchange="renderLogs()">
                  <option value="ALL">Tous modules</option>
                  <option value="NetDesignX">NetDesignX</option>
                  <option value="NetCatX">NetCatX</option>
                  <option value="NetMarkX">NetMarkX</option>
                  <option value="NetCareX">NetCareX</option>
                  <option value="OPS">OPS</option>
                </select>
              </div>
            </div>

            <table class="data-table">
              <thead>
                <tr><th>Horodatage</th><th>Module</th><th>Action</th><th>D√©tail</th><th class="td-right">Statut</th></tr>
              </thead>
              <tbody id="logsBody"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>KPIs Inter-D√©partements</h3>
            <div class="hr"></div>
            <div style="display:grid;gap:12px;">
              <div><div class="muted">Time-to-market (Design‚ÜíLive)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiTTM">‚Äî</div></div>
              <div><div class="muted">Data Quality PIM (erreurs)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiDQ">‚Äî</div></div>
              <div><div class="muted">ROI Marketing (7j)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiROI">‚Äî</div></div>
              <div><div class="muted">SLA Support (24h)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiSLA">‚Äî</div></div>
            </div>
            <div class="hr"></div>
            <button class="btn" onclick="recalcEnterpriseKPIs()"><i class="fas fa-wand-magic-sparkles"></i> Recalculer</button>
          </div>
        </div>
      </section>

      <!-- NETDESIGNX -->
      <section id="design" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetDesignX <span style="color:#666;font-size:1rem;">| Design & Collection</span></h2>
            <span class="pill info"><i class="fas fa-diagram-project"></i> Workflow Studio</span>
          </div>
          <div class="toolbar-right">
            <div class="wf-tabs" data-tabs="design">
              <button class="tab active" onclick="setWfMode('design','blueprint')"><i class="fas fa-diagram-project"></i> Blueprint</button>
              <button class="tab" onclick="setWfMode('design','screenshot')"><i class="fas fa-image"></i> Screenshot n8n</button>
            </div>
            <button class="btn secondary" onclick="loadWorkflow('design')"><i class="fas fa-rotate"></i> Charger</button>
            <button class="btn" onclick="runWorkflow('design')"><i class="fas fa-play"></i> Ex√©cuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Id√©es</div><div class="stat-val" id="dIdeas">42</div><span class="pill ok">Backlog sain</span></div>
          <div class="card"><div class="muted">Prototypes 3D</div><div class="stat-val" id="dProto">15</div><span class="pill info">CLO3D</span></div>
          <div class="card"><div class="muted">Lead time validation</div><div class="stat-val" id="dLead">3.2 j</div><span class="pill warn">√Ä optimiser</span></div>
          <div class="card"><div class="muted">Compl√©tude 1er passage</div><div class="stat-val" id="dFirstPass">81%</div><span class="pill info">Gate Validation</span></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-studio" id="studioDesign">
            <div class="wf-controls">
              <div class="left">
                <span class="chip"><i class="fas fa-magnifying-glass"></i> Zoom / Pan / Fit / Fullscreen</span>
                <span class="chip" id="chipModeDesign"><i class="fas fa-diagram-project"></i> Mode: Blueprint</span>
              </div>
              <div class="right">
                <button class="iconbtn" onclick="wfZoom('design', 1.15)" title="Zoom +"><i class="fas fa-plus"></i></button>
                <button class="iconbtn" onclick="wfZoom('design', 1/1.15)" title="Zoom -"><i class="fas fa-minus"></i></button>
                <span class="chip zoomval" id="zoomLblDesign">100%</span>
                <button class="iconbtn" onclick="wfFit('design')" title="Fit to screen"><i class="fas fa-expand"></i></button>
                <button class="iconbtn" onclick="wfReset('design')" title="Reset view"><i class="fas fa-rotate-left"></i></button>
                <button class="iconbtn" onclick="wfFullscreen('design')" title="Fullscreen"><i class="fas fa-up-right-and-down-left-from-center"></i></button>
              </div>
            </div>

            <div class="wf-viewport" id="vpDesign"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
                <div class="toolbar-right">
                  <button class="btn secondary" onclick="wfSpeedToggle()"><i class="fas fa-gauge-high"></i> Vitesse: <span id="wfSpeedLbl">x1</span></button>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">Cycle time (croquis‚ÜíGo)</div><div class="v" id="dKpiCycle">‚Äî</div></div>
                <div class="mini"><div class="k">Taux No-Go</div><div class="v" id="dKpiNoGo">‚Äî</div></div>
                <div class="mini"><div class="k">Tickets IT</div><div class="v" id="dKpiTickets">‚Äî</div></div>
                <div class="mini"><div class="k">Handoff vers PIM</div><div class="v" id="dKpiHandoff">‚Äî</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermDesign"></div>
              <div class="hr"></div>
              <div class="hint">
                üí° Astuce pr√©sentation : clique ‚ÄúScreenshot n8n‚Äù puis ‚ÄúCharger image‚Äù ‚Üí tu importes tes captures n8n depuis ton PC.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- NETCATX -->
      <section id="cat" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetCatX <span style="color:#666;font-size:1rem;">| Catalogue / E-merchandising</span></h2>
            <span class="pill info"><i class="fas fa-tags"></i> Workflow Studio</span>
          </div>
          <div class="toolbar-right">
            <div class="wf-tabs" data-tabs="cat">
              <button class="tab active" onclick="setWfMode('cat','blueprint')"><i class="fas fa-diagram-project"></i> Blueprint</button>
              <button class="tab" onclick="setWfMode('cat','screenshot')"><i class="fas fa-image"></i> Screenshot n8n</button>
            </div>
            <button class="btn secondary" onclick="loadWorkflow('cat')"><i class="fas fa-rotate"></i> Charger</button>
            <button class="btn" onclick="runWorkflow('cat')"><i class="fas fa-play"></i> Ex√©cuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Produits Live</div><div class="stat-val" id="cLive">12,400</div><span class="pill ok">Stable</span></div>
          <div class="card"><div class="muted">Compl√©tude</div><div class="stat-val" id="cComp">98.7%</div><span class="pill ok">Tr√®s bon</span></div>
          <div class="card"><div class="muted">Time-to-publish</div><div class="stat-val" id="cPub">14 min</div><span class="pill info">Pipeline API</span></div>
          <div class="card"><div class="muted">Erreurs / 1000 SKU</div><div class="stat-val" id="cErrRate">0.8</div><span class="pill warn">Qualit√©</span></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-studio" id="studioCat">
            <div class="wf-controls">
              <div class="left">
                <span class="chip"><i class="fas fa-magnifying-glass"></i> Zoom / Pan / Fit / Fullscreen</span>
                <span class="chip" id="chipModeCat"><i class="fas fa-diagram-project"></i> Mode: Blueprint</span>
              </div>
              <div class="right">
                <button class="iconbtn" onclick="wfZoom('cat', 1.15)" title="Zoom +"><i class="fas fa-plus"></i></button>
                <button class="iconbtn" onclick="wfZoom('cat', 1/1.15)" title="Zoom -"><i class="fas fa-minus"></i></button>
                <span class="chip zoomval" id="zoomLblCat">100%</span>
                <button class="iconbtn" onclick="wfFit('cat')" title="Fit to screen"><i class="fas fa-expand"></i></button>
                <button class="iconbtn" onclick="wfReset('cat')" title="Reset view"><i class="fas fa-rotate-left"></i></button>
                <button class="iconbtn" onclick="wfFullscreen('cat')" title="Fullscreen"><i class="fas fa-up-right-and-down-left-from-center"></i></button>
              </div>
            </div>

            <div class="wf-viewport" id="vpCat"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">Succ√®s sync (%)</div><div class="v" id="cKpiSync">‚Äî</div></div>
                <div class="mini"><div class="k">Doublons g√©r√©s</div><div class="v" id="cKpiDup">‚Äî</div></div>
                <div class="mini"><div class="k">Dead-letter</div><div class="v" id="cKpiDLQ">‚Äî</div></div>
                <div class="mini"><div class="k">Publication</div><div class="v" id="cKpiPublish">‚Äî</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermCat"></div>
              <div class="hr"></div>
              <div class="hint">üéØ Ici tu expliques : ‚ÄúPIM = source de v√©rit√© + DLQ + alerting‚Äù. Tu as l‚Äôaudit trail et la maintenance visibles.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- NETMARKX -->
      <section id="promo" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetMarkX <span style="color:#666;font-size:1rem;">| Marketing & Communication</span></h2>
            <span class="pill info"><i class="fas fa-bullseye"></i> Automation & ROI</span>
          </div>
          <div class="toolbar-right">
            <select class="select" id="segmentSelect" onchange="updateSegment()">
              <option value="VIP">Segment VIP (>200‚Ç¨)</option>
              <option value="NEW">Nouveaux clients (30j)</option>
              <option value="CHURN">Risque churn (90j)</option>
            </select>
            <div class="wf-tabs" data-tabs="mark">
              <button class="tab active" onclick="setWfMode('mark','blueprint')"><i class="fas fa-diagram-project"></i> Blueprint</button>
              <button class="tab" onclick="setWfMode('mark','screenshot')"><i class="fas fa-image"></i> Screenshot n8n</button>
            </div>
            <button class="btn secondary" onclick="loadWorkflow('mark')"><i class="fas fa-rotate"></i> Charger</button>
            <button class="btn" onclick="runWorkflow('mark')"><i class="fas fa-play"></i> Ex√©cuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Emails (7j)</div><div class="stat-val" id="mSent">120k</div><span class="pill info">Klaviyo</span></div>
          <div class="card"><div class="muted">ROI Global</div><div class="stat-val" style="color:var(--success);" id="mROI">5.2x</div><span class="pill ok">Rentable</span></div>
          <div class="card"><div class="muted">Taux ouverture</div><div class="stat-val" id="mOpen">32%</div><span class="pill ok">Au-dessus m√©diane</span></div>
          <div class="card"><div class="muted">Alertes ROI</div><div class="stat-val" id="mAlerts">1</div><span class="pill warn">Seuil</span></div>
        </div>

        <div class="card" style="height:320px;margin-bottom:16px;">
          <h3>Performance Campagnes</h3>
          <div style="height:240px;margin-top:10px;"><canvas id="chartPromo"></canvas></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-studio" id="studioMark">
            <div class="wf-controls">
              <div class="left">
                <span class="chip"><i class="fas fa-magnifying-glass"></i> Zoom / Pan / Fit / Fullscreen</span>
                <span class="chip" id="chipModeMark"><i class="fas fa-diagram-project"></i> Mode: Blueprint</span>
              </div>
              <div class="right">
                <button class="iconbtn" onclick="wfZoom('mark', 1.15)" title="Zoom +"><i class="fas fa-plus"></i></button>
                <button class="iconbtn" onclick="wfZoom('mark', 1/1.15)" title="Zoom -"><i class="fas fa-minus"></i></button>
                <span class="chip zoomval" id="zoomLblMark">100%</span>
                <button class="iconbtn" onclick="wfFit('mark')" title="Fit to screen"><i class="fas fa-expand"></i></button>
                <button class="iconbtn" onclick="wfReset('mark')" title="Reset view"><i class="fas fa-rotate-left"></i></button>
                <button class="iconbtn" onclick="wfFullscreen('mark')" title="Fullscreen"><i class="fas fa-up-right-and-down-left-from-center"></i></button>
              </div>
            </div>

            <div class="wf-viewport" id="vpMark"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">Conversions</div><div class="v" id="mKpiConv">‚Äî</div></div>
                <div class="mini"><div class="k">CTR</div><div class="v" id="mKpiCTR">‚Äî</div></div>
                <div class="mini"><div class="k">ROAS</div><div class="v" id="mKpiROAS">‚Äî</div></div>
                <div class="mini"><div class="k">Budget pacing</div><div class="v" id="mKpiPacing">‚Äî</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermMark"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- NETCAREX -->
      <section id="care" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetCareX <span style="color:#666;font-size:1rem;">| Service Client</span></h2>
            <span class="pill info"><i class="fas fa-headset"></i> SLA & Retours</span>
          </div>
          <div class="toolbar-right">
            <div class="wf-tabs" data-tabs="care">
              <button class="tab active" onclick="setWfMode('care','blueprint')"><i class="fas fa-diagram-project"></i> Blueprint</button>
              <button class="tab" onclick="setWfMode('care','screenshot')"><i class="fas fa-image"></i> Screenshot n8n</button>
            </div>
            <button class="btn secondary" onclick="loadWorkflow('care')"><i class="fas fa-rotate"></i> Charger</button>
            <button class="btn" onclick="runWorkflow('care')"><i class="fas fa-play"></i> Ex√©cuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Tickets ouverts</div><div class="stat-val" id="sOpen">24</div><span class="pill warn">File active</span></div>
          <div class="card"><div class="muted">SLA (24h)</div><div class="stat-val" id="sSLA">92%</div><span class="pill warn">√Ä remonter</span></div>
          <div class="card"><div class="muted">First response</div><div class="stat-val" id="sFRT">1h 12m</div><span class="pill ok">Correct</span></div>
          <div class="card"><div class="muted">CSAT</div><div class="stat-val" style="color:var(--primary);" id="sCSAT">4.8/5</div><span class="pill ok">Top</span></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-studio" id="studioCare">
            <div class="wf-controls">
              <div class="left">
                <span class="chip"><i class="fas fa-magnifying-glass"></i> Zoom / Pan / Fit / Fullscreen</span>
                <span class="chip" id="chipModeCare"><i class="fas fa-diagram-project"></i> Mode: Blueprint</span>
              </div>
              <div class="right">
                <button class="iconbtn" onclick="wfZoom('care', 1.15)" title="Zoom +"><i class="fas fa-plus"></i></button>
                <button class="iconbtn" onclick="wfZoom('care', 1/1.15)" title="Zoom -"><i class="fas fa-minus"></i></button>
                <span class="chip zoomval" id="zoomLblCare">100%</span>
                <button class="iconbtn" onclick="wfFit('care')" title="Fit to screen"><i class="fas fa-expand"></i></button>
                <button class="iconbtn" onclick="wfReset('care')" title="Reset view"><i class="fas fa-rotate-left"></i></button>
                <button class="iconbtn" onclick="wfFullscreen('care')" title="Fullscreen"><i class="fas fa-up-right-and-down-left-from-center"></i></button>
              </div>
            </div>

            <div class="wf-viewport" id="vpCare"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">TTR (r√©solution)</div><div class="v" id="sKpiTTR">‚Äî</div></div>
                <div class="mini"><div class="k">SLA breach</div><div class="v" id="sKpiBreach">‚Äî</div></div>
                <div class="mini"><div class="k">Automatisation</div><div class="v" id="sKpiAuto">‚Äî</div></div>
                <div class="mini"><div class="k">RMA g√©n√©r√©s</div><div class="v" id="sKpiRMA">‚Äî</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermCare"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <h3>File Tickets (d√©mo)</h3>
          <table class="data-table">
            <thead><tr><th>ID</th><th>Client</th><th>Motif</th><th>Priorit√©</th><th class="td-right">Actions</th></tr></thead>
            <tbody id="ticketsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- OPS -->
      <section id="ops" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">Audit & Conformit√©</h2>
            <span class="pill info"><i class="fas fa-shield-halved"></i> Audit Trail</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="exportAuditCSV()"><i class="fas fa-file-export"></i> Export Audit</button>
            <button class="btn" onclick="toast('ok','Conformit√©','Contr√¥les OK (d√©mo).')"><i class="fas fa-check"></i> Run Checks</button>
          </div>
        </div>

        <div class="card">
          <h3>Journal d'audit (d√©mo)</h3>
          <div class="muted" style="margin-bottom:10px;">Qui a fait quoi, quand, et sur quel outil. (La partie qui pla√Æt aux profs.)</div>
          <table class="data-table">
            <thead><tr><th>Date</th><th>Utilisateur</th><th>Module</th><th>Action</th><th>D√©tail</th><th class="td-right">Niveau</th></tr></thead>
            <tbody id="auditBody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <!-- FULLSCREEN MODAL -->
  <div class="modal" id="fsModal">
    <div class="box">
      <div class="bar">
        <div class="title" id="fsTitle">Workflow</div>
        <div class="actions">
          <button class="btn secondary" onclick="fsClose()"><i class="fas fa-xmark"></i> Fermer</button>
        </div>
      </div>
      <div class="content" id="fsContent"></div>
    </div>
  </div>

  <script>
    /* =========================
       CLOCK
    ========================= */
    setInterval(()=> document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 500);

    /* =========================
       CHARTS ‚Äî Dashboard Pro
       (On laisse Chart.js g√©rer les couleurs d√©j√† pr√©vues)
    ========================= */
    const chartTTM = new Chart(document.getElementById('chartTTM').getContext('2d'), {
      type:'line',
      data:{
        labels:['S1','S2','S3','S4','S5','S6'],
        datasets:[{label:'Lead Time (jours)', data:[22,20,19,17,16,15], borderColor:'#d4af37', backgroundColor:'rgba(212,175,55,.10)', fill:true, tension:.35}]
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#777'}},y:{ticks:{color:'#777'}}}}
    });

    const chartDQ = new Chart(document.getElementById('chartDQ').getContext('2d'), {
      type:'bar',
      data:{
        labels:['Doublons','Prix','Stock','Tailles','SEO','Images'],
        datasets:[{label:'Erreurs', data:[0.4,0.8,0.6,0.9,0.7,0.5], borderColor:'#4dabf7', backgroundColor:'rgba(77,171,247,.18)'}]
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#777'}},y:{ticks:{color:'#777'}}}}
    });

    const chartROI = new Chart(document.getElementById('chartROI').getContext('2d'), {
      type:'doughnut',
      data:{
        labels:['Paid Social','Email/CRM','Influence','SEO'],
        datasets:[{data:[38,26,20,16], backgroundColor:['rgba(212,175,55,.7)','rgba(81,207,102,.55)','rgba(77,171,247,.55)','rgba(255,212,59,.55)']}]
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#b8c1cc'}}}}
    });

    const chartSLA = new Chart(document.getElementById('chartSLA').getContext('2d'), {
      type:'radar',
      data:{
        labels:['SLA 24h','FRT','TTR','CSAT','Auto-resolve'],
        datasets:[{label:'Score', data:[92,78,74,90,62], borderColor:'#51cf66', backgroundColor:'rgba(81,207,102,.12)', pointBackgroundColor:'#51cf66'}]
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{r:{ticks:{display:false}, grid:{color:'rgba(255,255,255,.08)'}, angleLines:{color:'rgba(255,255,255,.08)'}, pointLabels:{color:'#b8c1cc'}}}}
    });

    /* Marketing chart (ton ancien) */
    const ctxPromo = document.getElementById('chartPromo').getContext('2d');
    const promoChart = new Chart(ctxPromo, {
      type: 'line',
      data: {
        labels: ['L', 'M', 'M', 'J', 'V', 'S', 'D'],
        datasets: [{
          label: 'Ventes Campagne (‚Ç¨)',
          data: [1200, 1900, 3000, 5000, 4200, 6000, 7000],
          borderColor: '#d4af37',
          backgroundColor: 'rgba(212, 175, 55, 0.1)',
          fill: true,
          tension: .35
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales:{x:{ticks:{color:'#777'}},y:{ticks:{color:'#777'}}}
      }
    });

    function updateSegment(){
      const seg = document.getElementById('segmentSelect').value;
      if(seg==='VIP'){
        setText('mSent','120k'); setText('mROI','5.2x'); setText('mOpen','32%'); setText('mAlerts','1');
        promoChart.data.datasets[0].data = [1200,1900,3000,5000,4200,6000,7000];
      } else if(seg==='NEW'){
        setText('mSent','75k'); setText('mROI','3.1x'); setText('mOpen','38%'); setText('mAlerts','0');
        promoChart.data.datasets[0].data = [900,1400,2300,3400,3100,4200,4800];
      } else {
        setText('mSent','40k'); setText('mROI','2.4x'); setText('mOpen','26%'); setText('mAlerts','2');
        promoChart.data.datasets[0].data = [700,1100,1700,2100,2400,2600,2800];
      }
      promoChart.update();
      toast('info','Segment',`Segment actif: ${seg}`);
      audit('Admin','NetMarkX','UPDATE_SEGMENT',`Segment=${seg}`,'INFO');
      pushLog('NetMarkX','Segment',`Set=${seg}`,'OK');
    }

    /* =========================
       NAV
    ========================= */
    function nav(id, el) {
      document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      el.classList.add('active');
      document.getElementById('pageTitle').innerText = id.charAt(0).toUpperCase() + id.slice(1);

      const mod = id==='design'?'NetDesignX':id==='cat'?'NetCatX':id==='promo'?'NetMarkX':id==='care'?'NetCareX':id==='ops'?'OPS':'OPS';
      audit('Admin', mod, 'NAVIGATE', `to=${id}`, 'INFO');
      pushLog(mod,'Navigate',`to=${id}`,'OK');

      if(id==='design') ensureStudio('design');
      if(id==='cat') ensureStudio('cat');
      if(id==='promo') ensureStudio('mark');
      if(id==='care') ensureStudio('care');
    }

    /* =========================
       UTIL
    ========================= */
    function setText(id, v){ const el=document.getElementById(id); if(el) el.innerText = v; }
    function fmt(n){ return n.toLocaleString('fr-CH'); }
    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    /* =========================
       TOASTS
    ========================= */
    function toast(type, title, msg){
      const host = document.getElementById('toasts');
      const el = document.createElement('div');
      el.className = 'toast ' + (type||'info');
      el.innerHTML = `
        <div>
          <div class="t-title">${title}</div>
          <div class="t-msg">${msg}</div>
        </div>
        <button class="t-close" aria-label="close">&times;</button>
      `;
      el.querySelector('.t-close').onclick = ()=> el.remove();
      host.appendChild(el);
      setTimeout(()=> { if(el.isConnected) el.remove(); }, 4200);
    }

    /* =========================
       LOGS
    ========================= */
    const logs = [];
    const logsSeed = [
      {mod:'NetCatX', act:'Sync Shopify', det:'150 items', status:'OK'},
      {mod:'NetMarkX', act:'Email Sent', det:'Segment VIP', status:'OK'},
      {mod:'NetCareX', act:'Ticket Closed', det:'Refund #882', status:'OK'},
      {mod:'NetDesignX', act:'3D Render', det:'Veste Hiver', status:'OK'},
      {mod:'OPS', act:'Policy Check', det:'GDPR consent OK', status:'OK'},
      {mod:'NetCatX', act:'Rule Engine', det:'SEO title missing (SKU BST-2025)', status:'WARN'}
    ];

    function pushLog(mod, act, det, status='OK'){
      logs.unshift({ts:new Date(), mod, act, det, status});
      if(logs.length>120) logs.pop();
      renderLogs();
    }

    function renderLogs(){
      const q = (document.getElementById('logSearch')?.value||'').toLowerCase();
      const f = document.getElementById('logFilter')?.value || 'ALL';
      const rows = logs
        .filter(l => (f==='ALL' || l.mod===f))
        .filter(l => (`${l.mod} ${l.act} ${l.det}`.toLowerCase().includes(q)));

      const body = document.getElementById('logsBody');
      if(!body) return;

      body.innerHTML = rows.slice(0,14).map(l=>{
        const st = l.status==='OK'
          ? `<span class="pill ok">OK</span>`
          : l.status==='WARN'
            ? `<span class="pill warn">WARN</span>`
            : `<span class="pill bad">FAIL</span>`;
        return `
          <tr>
            <td class="mono" style="font-size:.78rem;color:#9aa3ad;">${l.ts.toLocaleTimeString()}</td>
            <td><span style="color:var(--primary)">${l.mod}</span></td>
            <td>${l.act}</td>
            <td>${l.det}</td>
            <td class="td-right">${st}</td>
          </tr>`;
      }).join('');

      if(rows.length===0){
        body.innerHTML = `<tr><td colspan="5"><div class="empty">Aucun r√©sultat.</div></td></tr>`;
      }
    }

    for(let i=0;i<12;i++){
      const s=pick(logsSeed);
      pushLog(s.mod,s.act,s.det,s.status);
    }
    setInterval(()=>{
      const s = pick(logsSeed);
      let det = s.det;
      if(s.mod==='NetCatX' && s.act==='Sync Shopify') det = `${rand(80,260)} items`;
      if(s.mod==='NetMarkX' && s.act==='Email Sent') det = `Batch ${fmt(rand(10_000, 55_000))}`;
      if(s.mod==='NetCareX' && s.act==='Ticket Closed') det = `Ticket #${rand(800,999)}`;
      pushLog(s.mod, s.act, det, s.status);
    }, 3600);

    function exportLogsCSV(){
      const header = ['timestamp','module','action','detail','status'];
      const lines = [header.join(',')].concat(
        logs.map(l => [
          l.ts.toISOString(),
          `"${l.mod}"`,
          `"${l.act}"`,
          `"${String(l.det).replaceAll('"','""')}"`,
          l.status
        ].join(','))
      );
      downloadFile('netmarket_logs.csv', lines.join('\n'));
      toast('ok','Export','CSV t√©l√©charg√©: netmarket_logs.csv');
      audit('Admin','OPS','EXPORT','logs=csv','INFO');
    }

    function downloadFile(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    /* =========================
       AUDIT TRAIL
    ========================= */
    const auditEvents = [];
    function audit(user, module, action, detail, level){
      auditEvents.unshift({ts:new Date(), user, module, action, detail, level});
      if(auditEvents.length>80) auditEvents.pop();
      renderAudit();
    }
    function renderAudit(){
      const body = document.getElementById('auditBody');
      if(!body) return;
      const rows = auditEvents.slice(0,18);
      body.innerHTML = rows.map(a=>{
        const pill = a.level==='WARN' ? 'warn' : (a.level==='ERROR'?'bad':'info');
        return `
          <tr>
            <td class="mono" style="font-size:.78rem;color:#9aa3ad;">${a.ts.toLocaleString()}</td>
            <td>${a.user}</td>
            <td><span style="color:var(--primary)">${a.module}</span></td>
            <td class="mono" style="font-size:.78rem;color:#cbd5e1;">${a.action}</td>
            <td>${a.detail}</td>
            <td class="td-right"><span class="pill ${pill}">${a.level}</span></td>
          </tr>`;
      }).join('');
      if(rows.length===0){
        body.innerHTML = `<tr><td colspan="6"><div class="empty">Aucun √©v√©nement.</div></td></tr>`;
      }
    }
    function exportAuditCSV(){
      const header = ['timestamp','user','module','action','detail','level'];
      const lines = [header.join(',')].concat(
        auditEvents.map(a => [
          a.ts.toISOString(),
          `"${a.user}"`,
          `"${a.module}"`,
          `"${a.action}"`,
          `"${String(a.detail).replaceAll('"','""')}"`,
          a.level
        ].join(','))
      );
      downloadFile('netmarket_audit.csv', lines.join('\n'));
      toast('ok','Export','CSV t√©l√©charg√©: netmarket_audit.csv');
    }

    /* =========================
       ENTERPRISE KPIs
    ========================= */
    function recalcEnterpriseKPIs(){
      const ttm = rand(10, 22);        // days
      const dq = (Math.random()*1.5).toFixed(2); // errors/1000
      const roi = (2 + Math.random()*4).toFixed(1);
      const sla = rand(88, 97);

      setText('kpiTTM', `${ttm} j`);
      setText('kpiDQ', `${dq} / 1000`);
      setText('kpiROI', `${roi}x`);
      setText('kpiSLA', `${sla}%`);

      toast('info','KPIs', 'KPIs recalcul√©s (d√©mo).');
      audit('Admin','OPS','KPI_RECALC',`ttm=${ttm}j dq=${dq}/1000 roi=${roi}x sla=${sla}%`,'INFO');
      pushLog('OPS','KPI','Recalc enterprise KPIs','OK');
    }
    recalcEnterpriseKPIs();

    /* =========================
       TICKETS (Support)
    ========================= */
    const tickets = [
      {id:'#1042', client:'Julie M.', motif:'Retour - taille', prio:'Haute'},
      {id:'#1043', client:'Karim S.', motif:'Livraison en retard', prio:'Moyenne'},
      {id:'#1044', client:'Emma R.', motif:'Facturation', prio:'Basse'},
      {id:'#1045', client:'Noah L.', motif:'Produit d√©fectueux', prio:'Haute'}
    ];
    function renderTickets(){
      const body = document.getElementById('ticketsBody');
      if(!body) return;
      body.innerHTML = tickets.map(t=>{
        const p = t.prio==='Haute' ? 'warn' : (t.prio==='Moyenne'?'info':'ok');
        return `
          <tr>
            <td class="mono" style="font-size:.78rem;color:#cbd5e1;">${t.id}</td>
            <td>${t.client}</td>
            <td>${t.motif}</td>
            <td><span class="pill ${p}">${t.prio}</span></td>
            <td class="td-right">
              <button class="btn secondary" style="padding:7px 10px" onclick="autoReply('${t.id}')"><i class="fas fa-wand-magic-sparkles"></i></button>
              <button class="btn secondary" style="padding:7px 10px" onclick="closeTicket('${t.id}')"><i class="fas fa-check"></i></button>
            </td>
          </tr>`;
      }).join('');
    }
    renderTickets();

    function autoReply(id){
      toast('info','R√©ponse IA',`Draft g√©n√©r√© pour ${id} (d√©mo).`);
      pushLog('NetCareX','AI Draft',`ticket=${id}`,'OK');
      audit('Admin','NetCareX','AI_DRAFT',`ticket=${id}`,'INFO');
    }
    function closeTicket(id){
      const i = tickets.findIndex(t=>t.id===id);
      if(i>=0) tickets.splice(i,1);
      renderTickets();
      toast('ok','Ticket',`${id} clos.`);
      pushLog('NetCareX','Ticket Closed',`${id}`,'OK');
      audit('Admin','NetCareX','CLOSE_TICKET',`ticket=${id}`,'INFO');
      const open = Math.max(0, parseInt(document.getElementById('sOpen').innerText,10)-1);
      setText('sOpen', String(open));
      const sla = Math.min(99, rand(90,96));
      setText('sSLA', `${sla}%`);
    }

    /* =========================================================
       WORKFLOW STUDIO ENGINE (Pan/Zoom + Blueprint + Screenshot)
    ========================================================= */
    let wfSpeed = 1;

    function wfSpeedToggle(){
      wfSpeed = (wfSpeed===1?2:(wfSpeed===2?3:1));
      const el = document.getElementById('wfSpeedLbl');
      if(el) el.innerText = 'x'+wfSpeed;
      toast('info','Workflow',`Vitesse x${wfSpeed}`);
    }

    const ICON = {
      webhook:'fa-code-branch', cron:'fa-clock', file:'fa-file', db:'fa-database',
      validate:'fa-check', if:'fa-code-compare', code:'fa-code', doc:'fa-folder-open',
      approval:'fa-user-check', decision:'fa-circle-nodes', pim:'fa-tags',
      shopify:'fa-shopify', sheet:'fa-table', alert:'fa-bell', retry:'fa-rotate-right',
      dlq:'fa-inbox', monitor:'fa-chart-line', ticket:'fa-ticket', stop:'fa-ban',
      social:'fa-hashtag', klaviyo:'fa-paper-plane', analytics:'fa-chart-simple',
      classify:'fa-filter', lookup:'fa-magnifying-glass', rules:'fa-scale-balanced',
      refund:'fa-coins', shipping:'fa-truck-fast', notify:'fa-bullhorn', feedback:'fa-star'
    };

    // camera state per workflow
    const CAM = {
      design:{scale:1, tx:30, ty:30, mode:'blueprint'},
      cat:{scale:1, tx:30, ty:30, mode:'blueprint'},
      mark:{scale:1, tx:30, ty:30, mode:'blueprint'},
      care:{scale:1, tx:30, ty:30, mode:'blueprint'}
    };

    // screenshot storage (dataURL) per workflow
    const SHOTS = {
      design: localStorage.getItem('shot_design') || '',
      cat: localStorage.getItem('shot_cat') || '',
      mark: localStorage.getItem('shot_mark') || '',
      care: localStorage.getItem('shot_care') || ''
    };

    const WORKFLOWS = {
      design: {
        module: 'NetDesignX',
        viewportId:'vpDesign',
        termId:'wfTermDesign',
        chipId:'chipModeDesign',
        zoomLbl:'zoomLblDesign',
        kpiSet: (m)=>{ setText('dKpiCycle',m.cycle); setText('dKpiNoGo',m.nogo); setText('dKpiTickets',m.tickets); setText('dKpiHandoff',m.handoff); },
        nodes: [
          {id:'d1', x:90,  y:120, type:'webhook',  title:'Webhook', sub:'Collection valid√©e'},
          {id:'d2', x:90,  y:260, type:'file',     title:'Trigger fichier', sub:'Tech pack / 3D'},
          {id:'d3', x:90,  y:400, type:'cron',     title:'Cron', sub:'Rappel validation'},
          {id:'d4', x:360, y:260, type:'doc',      title:'Capture & structuration', sub:'Set / Merge fields'},
          {id:'d5', x:610, y:260, type:'validate', title:'Validation', sub:'IF complet ?'},
          {id:'d6', x:860, y:260, type:'code',     title:'Normalisation', sub:'Mapping NetMarket'},
          {id:'d7', x:1110,y:260, type:'doc',      title:'Gestion doc', sub:'Versioning centralis√©'},
          {id:'d8', x:1360,y:260, type:'approval', title:'Approbation', sub:'Chef de produit'},
          {id:'d9', x:1610,y:260, type:'decision', title:'Go / No-Go', sub:'Gate final'},
          {id:'d13',x:1610,y:420, type:'pim',      title:'Push PIM', sub:'Akeneo ‚Üí Catalogue'},
          {id:'d14',x:1610,y:560, type:'stop',     title:'Stop/Log', sub:'No-Go + relance'},
          {id:'d11',x:1880,y:260, type:'sheet',    title:'Journalisation & KPI', sub:'Audit + KPIs'},
          {id:'d10',x:1880,y:420, type:'retry',    title:'Retry', sub:'Relance automatique'},
          {id:'d12',x:1880,y:560, type:'ticket',   title:'Ticket IT', sub:'Blocage / incident'},
          {id:'d15',x:1360,y:560, type:'alert',    title:'Watcher', sub:'Monitoring + alerting'}
        ],
        edges: [
          ['d1','d4'],['d2','d4'],['d3','d4'],
          ['d4','d5'],['d5','d6'],['d6','d7'],['d7','d8'],['d8','d9'],
          ['d9','d13'],['d9','d14'],['d9','d11'],
          ['d11','d10'],['d10','d12'],['d12','d15'],['d15','d11']
        ],
        run: [
          {node:'d1', log:'WEBHOOK: collection valid√©e re√ßue'},
          {node:'d4', log:'CAPTURE: consolidation croquis + tech pack + metadata'},
          {node:'d5', log:'VALIDATION: tailles, mati√®res, BOM, conformit√©'},
          {node:'d6', log:'NORMALISATION: mapping attributs NetMarket'},
          {node:'d7', log:'DOC: versioning + stockage (r√©f√©rentiel unique)'},
          {node:'d8', log:'APPROVAL: validation chef de produit'},
          {node:'d9', log:'GATE: d√©cision Go / No-Go'},
          {node:'d13',log:'GO: push Akeneo + handoff Catalogue'},
          {node:'d11',log:'KPI: cycle time + first pass + tra√ßabilit√©'}
        ]
      },

      cat: {
        module: 'NetCatX',
        viewportId:'vpCat',
        termId:'wfTermCat',
        chipId:'chipModeCat',
        zoomLbl:'zoomLblCat',
        kpiSet: (m)=>{ setText('cKpiSync',m.sync); setText('cKpiDup',m.dup); setText('cKpiDLQ',m.dlq); setText('cKpiPublish',m.publish); },
        nodes: [
          {id:'c1', x:90,  y:160, type:'file',     title:'Trigger CSV', sub:'Fournisseur'},
          {id:'c2', x:360, y:160, type:'doc',      title:'Set/Rename', sub:'Mapping champs'},
          {id:'c3', x:610, y:160, type:'validate', title:'Validation', sub:'Obligatoires + r√®gles'},
          {id:'c4', x:860, y:160, type:'code',     title:'Normalisation', sub:'Tailles/couleurs'},
          {id:'c5', x:1110,y:160, type:'if',       title:'IF doublons', sub:'Create vs Update'},
          {id:'c6', x:1360,y:80,  type:'pim',      title:'Akeneo Create', sub:'Produit + variantes'},
          {id:'c7', x:1360,y:240, type:'pim',      title:'Akeneo Update', sub:'Mise √† jour'},
          {id:'c8', x:1610,y:160, type:'shopify',  title:'Shopify', sub:'Publication'},
          {id:'c9', x:1860,y:160, type:'sheet',    title:'Logs & KPI', sub:'Journalisation'},
          {id:'c10',x:1610,y:320, type:'retry',    title:'Retry x3', sub:'Relance'},
          {id:'c11',x:1860,y:320, type:'dlq',      title:'Dead-letter', sub:'Stocker √©checs'},
          {id:'c12',x:2100,y:320, type:'alert',    title:'Alerting', sub:'Teams/Email/Ticket'},
          {id:'c13',x:2100,y:160, type:'monitor',  title:'Monitoring', sub:'Rapport quotidien'}
        ],
        edges: [
          ['c1','c2'],['c2','c3'],['c3','c4'],['c4','c5'],
          ['c5','c6'],['c5','c7'],['c6','c8'],['c7','c8'],
          ['c8','c9'],['c8','c10'],['c10','c11'],['c11','c12'],['c12','c13'],['c13','c9']
        ],
        run: [
          {node:'c1', log:'TRIGGER: CSV fournisseur d√©tect√©'},
          {node:'c2', log:'MAPPING: champs vers mod√®le NetMarket'},
          {node:'c3', log:'VALIDATION: prix/stock/images/SEO'},
          {node:'c4', log:'NORMALISATION: tailles EU/US + nettoyage'},
          {node:'c5', log:'DEDUP: create vs update'},
          {node:'c6', log:'PIM: cr√©ation Akeneo'},
          {node:'c8', log:'PUBLISH: publication Shopify'},
          {node:'c9', log:'LOG: KPI data quality + audit'}
        ]
      },

      mark: {
        module: 'NetMarkX',
        viewportId:'vpMark',
        termId:'wfTermMark',
        chipId:'chipModeMark',
        zoomLbl:'zoomLblMark',
        kpiSet: (m)=>{ setText('mKpiConv',m.conv); setText('mKpiCTR',m.ctr); setText('mKpiROAS',m.roas); setText('mKpiPacing',m.pacing); },
        nodes: [
          {id:'m1', x:90,  y:200, type:'webhook',  title:'Webhook', sub:'Collection publi√©e'},
          {id:'m2', x:360, y:200, type:'if',       title:'Segmentation', sub:'VIP / New / Churn'},
          {id:'m3', x:610, y:200, type:'db',       title:'Enrichment', sub:'GA4 + CRM + Shopify'},
          {id:'m4', x:860, y:120, type:'klaviyo',  title:'Klaviyo', sub:'Email/SMS automation'},
          {id:'m5', x:860, y:280, type:'social',   title:'Social', sub:'Buffer/Hootsuite'},
          {id:'m6', x:1110,y:200, type:'analytics',title:'Tracking', sub:'ROI/CTR/Conv'},
          {id:'m7', x:1360,y:200, type:'sheet',    title:'Dashboard', sub:'Log + KPI'},
          {id:'m8', x:1610,y:200, type:'if',       title:'Alerting IF', sub:'ROI < seuil'},
          {id:'m9', x:1860,y:120, type:'alert',    title:'Notif', sub:'Stop/optimisation'},
          {id:'m10',x:1860,y:280, type:'monitor',  title:'Maintenance', sub:'UTM/budget/rapport'}
        ],
        edges: [
          ['m1','m2'],['m2','m3'],['m3','m4'],['m3','m5'],
          ['m4','m6'],['m5','m6'],['m6','m7'],['m7','m8'],
          ['m8','m9'],['m8','m10'],['m10','m7']
        ],
        run: [
          {node:'m1', log:'START: lancement campagne sur collection'},
          {node:'m2', log:'SEGMENT: ciblage clients'},
          {node:'m3', log:'DATA: enrichissement (GA4/CRM/Shopify)'},
          {node:'m4', log:'CRM: envoi flows Klaviyo'},
          {node:'m5', log:'SOCIAL: publication programm√©e'},
          {node:'m6', log:'TRACK: ROI/CTR/Conv'},
          {node:'m8', log:'ALERT: si ROI bas ‚Üí action'},
          {node:'m7', log:'KPI: consolidation performance'}
        ]
      },

      care: {
        module: 'NetCareX',
        viewportId:'vpCare',
        termId:'wfTermCare',
        chipId:'chipModeCare',
        zoomLbl:'zoomLblCare',
        kpiSet: (m)=>{ setText('sKpiTTR',m.ttr); setText('sKpiBreach',m.breach); setText('sKpiAuto',m.auto); setText('sKpiRMA',m.rma); },
        nodes: [
          {id:'s1', x:90,  y:200, type:'ticket',   title:'Ticket', sub:'Zendesk/Gorgias'},
          {id:'s2', x:360, y:200, type:'classify', title:'Classifier', sub:'IA / IF'},
          {id:'s3', x:610, y:200, type:'lookup',   title:'Lookup', sub:'Commande Shopify'},
          {id:'s4', x:860, y:200, type:'rules',    title:'Rules', sub:'<30j ? d√©faut ? SLA'},
          {id:'s5', x:1110,y:80,  type:'shipping', title:'Retour', sub:'√âtiquette + email'},
          {id:'s6', x:1110,y:200, type:'doc',      title:'√âchange', sub:'Nouvelle commande'},
          {id:'s7', x:1110,y:320, type:'refund',   title:'Remboursement', sub:'D√©clencher'},
          {id:'s8', x:1360,y:200, type:'doc',      title:'Update Ticket', sub:'Status + tags'},
          {id:'s9', x:1610,y:200, type:'sheet',    title:'Logs & KPI', sub:'Audit + SLA'},
          {id:'s10',x:1860,y:200, type:'if',       title:'SLA IF', sub:'Breach ?'},
          {id:'s11',x:2100,y:200, type:'alert',    title:'Escalade', sub:'Responsable support'},
          {id:'s12',x:1610,y:360, type:'feedback', title:'CSAT', sub:'Survey satisfaction'}
        ],
        edges: [
          ['s1','s2'],['s2','s3'],['s3','s4'],
          ['s4','s5'],['s4','s6'],['s4','s7'],
          ['s5','s8'],['s6','s8'],['s7','s8'],
          ['s8','s9'],['s9','s10'],['s10','s11'],['s8','s12']
        ],
        run: [
          {node:'s1', log:'TICKET: cr√©ation demande client'},
          {node:'s2', log:'CLASSIF: motif + priorit√©'},
          {node:'s3', log:'LOOKUP: commande'},
          {node:'s4', log:'RULES: d√©cision action'},
          {node:'s5', log:'ACTION: retour standard'},
          {node:'s8', log:'UPDATE: ticket + SLA'},
          {node:'s9', log:'KPI: temps & satisfaction'},
          {node:'s12',log:'CSAT: survey envoy√©e'}
        ]
      }
    };

    /* =========================
       STUDIO RENDERING
    ========================= */
    const STUDIO = {}; // per key: {vp, world, svg, nodesHost, shotEl, ...}
    const drag = {active:false, key:null, nodeId:null, dx:0, dy:0, panning:false, px:0, py:0};

    function ensureStudio(key){
      if(STUDIO[key]) return;

      const wf = WORKFLOWS[key];
      const vp = document.getElementById(wf.viewportId);
      if(!vp) return;

      vp.innerHTML = ''; // build viewport content
      const world = document.createElement('div');
      world.className = 'wf-world';
      world.id = `world_${key}`;

      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.classList.add('wf-svg');
      svg.setAttribute('width','2200');
      svg.setAttribute('height','1400');
      svg.setAttribute('viewBox','0 0 2200 1400');

      const nodesHost = document.createElement('div');
      nodesHost.className = 'wf-nodes';
      nodesHost.id = `nodes_${key}`;

      world.appendChild(svg);
      world.appendChild(nodesHost);
      vp.appendChild(world);

      // interactions pan/zoom
      vp.addEventListener('wheel', (e)=> onWheel(e, key), {passive:false});
      vp.addEventListener('mousedown', (e)=> onPanStart(e, key));
      window.addEventListener('mousemove', (e)=> onPanMove(e, key));
      window.addEventListener('mouseup', ()=> onPanEnd(key));

      STUDIO[key] = {vp, world, svg, nodesHost};
      loadWorkflow(key);       // render blueprint nodes by default
      applyCam(key);
      wfFit(key);              // cadrage auto au chargement ‚Üí plus de ‚Äúje vois pas tout‚Äù
    }

    function setWfMode(key, mode){
      CAM[key].mode = mode;

      // tabs active UI
      const tabs = document.querySelectorAll(`.wf-tabs[data-tabs="${key}"] .tab`);
      tabs.forEach(t=>t.classList.remove('active'));
      // find button by onclick string
      const target = Array.from(tabs).find(b => (b.getAttribute('onclick')||'').includes(`'${mode}'`));
      if(target) target.classList.add('active');

      // chip
      const chip = document.getElementById(WORKFLOWS[key].chipId);
      if(chip){
        chip.innerHTML = mode==='blueprint'
          ? `<i class="fas fa-diagram-project"></i> Mode: Blueprint`
          : `<i class="fas fa-image"></i> Mode: Screenshot n8n`;
      }

      // re-render
      loadWorkflow(key);
      wfFit(key);
      toast('info','Mode', `${WORKFLOWS[key].module}: ${mode}`);
    }

    function loadWorkflow(key){
      ensureStudio(key);
      const wf = WORKFLOWS[key];
      const st = STUDIO[key];

      st.nodesHost.innerHTML = '';
      st.svg.innerHTML = '';

      if(CAM[key].mode === 'screenshot'){
        renderScreenshotWorld(key);
        return;
      }

      // blueprint nodes
      renderNodes(key);
      drawEdges(key);
      termLog(key, `>> Workflow charg√© (${wf.module}) ‚Äî mode Blueprint`);
      pushLog(wf.module,'Workflow','Loaded (Blueprint)','OK');
      audit('Admin', wf.module, 'WF_LOAD', 'loaded blueprint', 'INFO');

      // baseline KPIs
      if(key==='design') wf.kpiSet({cycle:'‚Äî',nogo:'‚Äî',tickets:'‚Äî',handoff:'‚Äî'});
      if(key==='cat') wf.kpiSet({sync:'‚Äî',dup:'‚Äî',dlq:'‚Äî',publish:'‚Äî'});
      if(key==='mark') wf.kpiSet({conv:'‚Äî',ctr:'‚Äî',roas:'‚Äî',pacing:'‚Äî'});
      if(key==='care') wf.kpiSet({ttr:'‚Äî',breach:'‚Äî',auto:'‚Äî',rma:'‚Äî'});
    }

    function renderScreenshotWorld(key){
      const wf = WORKFLOWS[key];
      const st = STUDIO[key];

      // clear
      st.nodesHost.innerHTML = '';
      st.svg.innerHTML = '';

      const shot = document.createElement('div');
      shot.className = 'wf-shot';
      shot.id = `shot_${key}`;

      const inputId = `file_${key}`;
      shot.innerHTML = `
        <header>
          <div class="left">
            <span>${wf.module}</span>
            <div class="hint">Importe ta capture n8n (PNG/JPG). Stock√©e localement (localStorage).</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="${inputId}" type="file" accept="image/*" style="display:none">
            <button class="btn secondary" onclick="pickShot('${key}')"><i class="fas fa-upload"></i> Charger image</button>
            <button class="btn danger" onclick="clearShot('${key}')"><i class="fas fa-trash"></i></button>
          </div>
        </header>
        <div class="body" id="shotBody_${key}">
          ${SHOTS[key]
            ? `<img src="${SHOTS[key]}" alt="n8n workflow screenshot">`
            : `<div class="placeholder">
                 <div style="font-weight:900;color:#dbe2ea;margin-bottom:6px;">Aucune image charg√©e</div>
                 <div>Cliquer ‚ÄúCharger image‚Äù ‚Üí s√©lectionner ton screenshot n8n.</div>
               </div>`}
        </div>
      `;

      st.nodesHost.appendChild(shot);

      // file handler
      const input = shot.querySelector(`#${inputId}`);
      input.addEventListener('change', (e)=> {
        const file = e.target.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=> {
          SHOTS[key] = reader.result;
          localStorage.setItem(`shot_${key}`, SHOTS[key]);
          setWfMode(key,'screenshot'); // rerender
          toast('ok','Screenshot',`Image charg√©e (${wf.module}).`);
          audit('Admin', wf.module, 'SHOT_UPLOAD', file.name, 'INFO');
          pushLog(wf.module,'Screenshot',`Uploaded ${file.name}`,'OK');
        };
        reader.readAsDataURL(file);
      });

      termLog(key, `>> Mode Screenshot pr√™t ‚Äî charge ta capture n8n.`);
    }

    function pickShot(key){
      const st = STUDIO[key];
      const input = st.nodesHost.querySelector(`input[type="file"]`);
      if(input) input.click();
    }
    function clearShot(key){
      SHOTS[key]='';
      localStorage.removeItem(`shot_${key}`);
      toast('warn','Screenshot','Image supprim√©e (local).');
      audit('Admin', WORKFLOWS[key].module, 'SHOT_CLEAR', 'localStorage cleared', 'WARN');
      pushLog(WORKFLOWS[key].module,'Screenshot','Cleared','WARN');
      setWfMode(key,'screenshot');
    }

    function renderNodes(key){
      const wf = WORKFLOWS[key];
      const st = STUDIO[key];

      for(const n of wf.nodes){
        const div = document.createElement('div');
        div.className = 'node';
        div.style.left = n.x + 'px';
        div.style.top  = n.y + 'px';
        div.dataset.id = n.id;

        const ic = ICON[n.type] || 'fa-circle';

        div.innerHTML = `
          <div class="ic"><i class="fas ${ic}"></i></div>
          <div class="t">
            <div class="title">${n.title}</div>
            <div class="sub">${n.sub}</div>
          </div>
          <div class="badge idle">IDLE</div>
        `;

        div.addEventListener('mousedown', (e)=> startNodeDrag(e, key, n.id));
        st.nodesHost.appendChild(div);
      }
    }

    function drawEdges(key){
      const wf = WORKFLOWS[key];
      const st = STUDIO[key];
      const svg = st.svg;

      svg.innerHTML = `
        <defs>
          <marker id="arrow-${key}" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(212,175,55,.55)"></path>
          </marker>
        </defs>
      `;

      const getNodeEl = (id)=> st.nodesHost.querySelector(`.node[data-id="${id}"]`);

      for(const [from,to] of wf.edges){
        const a = getNodeEl(from);
        const b = getNodeEl(to);
        if(!a || !b) continue;

        const ax = a.offsetLeft + a.offsetWidth;
        const ay = a.offsetTop  + a.offsetHeight/2;
        const bx = b.offsetLeft;
        const by = b.offsetTop  + b.offsetHeight/2;

        const mx = (ax + bx)/2;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', `M ${ax} ${ay} C ${mx} ${ay}, ${mx} ${by}, ${bx} ${by}`);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','rgba(212,175,55,.35)');
        path.setAttribute('stroke-width','2');
        path.setAttribute('marker-end', `url(#arrow-${key})`);
        svg.appendChild(path);
      }
    }

    /* =========================
       PAN / ZOOM CAMERA
    ========================= */
    function applyCam(key){
      const st = STUDIO[key];
      if(!st) return;
      const c = CAM[key];
      st.world.style.transform = `translate(${c.tx}px, ${c.ty}px) scale(${c.scale})`;
      const lbl = document.getElementById(WORKFLOWS[key].zoomLbl);
      if(lbl) lbl.textContent = Math.round(c.scale*100)+'%';
    }

    function onWheel(e, key){
      if(!STUDIO[key]) return;
      e.preventDefault();

      const vp = STUDIO[key].vp;
      const rect = vp.getBoundingClientRect();
      const c = CAM[key];

      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;

      const zoom = (e.deltaY < 0) ? 1.12 : 1/1.12;
      const newScale = clamp(c.scale * zoom, 0.35, 2.5);

      // zoom to cursor (pro feel)
      const wx = (mx - c.tx) / c.scale;
      const wy = (my - c.ty) / c.scale;

      c.scale = newScale;
      c.tx = mx - wx * c.scale;
      c.ty = my - wy * c.scale;

      applyCam(key);
    }

    function onPanStart(e, key){
      // avoid panning when dragging node (node uses its own handler)
      if(e.target.closest('.node')) return;
      if(CAM[key].mode === 'screenshot' && e.target.closest('button')) return;

      drag.panning = true;
      drag.key = key;
      drag.px = e.clientX;
      drag.py = e.clientY;

      const vp = STUDIO[key].vp;
      vp.classList.add('grabbing');
    }

    function onPanMove(e, key){
      if(!drag.panning || drag.key !== key) return;
      const c = CAM[key];

      const dx = e.clientX - drag.px;
      const dy = e.clientY - drag.py;

      drag.px = e.clientX;
      drag.py = e.clientY;

      c.tx += dx;
      c.ty += dy;

      applyCam(key);
    }

    function onPanEnd(key){
      if(!drag.panning) return;
      const k = drag.key;
      drag.panning = false;
      drag.key = null;
      if(STUDIO[k]) STUDIO[k].vp.classList.remove('grabbing');
    }

    function wfZoom(key, factor){
      CAM[key].scale = clamp(CAM[key].scale * factor, 0.35, 2.5);
      applyCam(key);
    }
    function wfReset(key){
      CAM[key].scale = 1;
      CAM[key].tx = 30;
      CAM[key].ty = 30;
      applyCam(key);
      toast('info','View', `${WORKFLOWS[key].module}: reset view`);
    }

    function wfFit(key){
      // fit nodes or screenshot box into viewport
      ensureStudio(key);
      const st = STUDIO[key];
      const vp = st.vp;
      const rect = vp.getBoundingClientRect();
      const pad = 60;

      let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;

      if(CAM[key].mode === 'screenshot'){
        const shot = st.nodesHost.querySelector('.wf-shot');
        if(shot){
          minX = shot.offsetLeft;
          minY = shot.offsetTop;
          maxX = shot.offsetLeft + shot.offsetWidth;
          maxY = shot.offsetTop + shot.offsetHeight;
        }
      } else {
        const nodes = st.nodesHost.querySelectorAll('.node');
        nodes.forEach(n=>{
          minX = Math.min(minX, n.offsetLeft);
          minY = Math.min(minY, n.offsetTop);
          maxX = Math.max(maxX, n.offsetLeft + n.offsetWidth);
          maxY = Math.max(maxY, n.offsetTop + n.offsetHeight);
        });
      }

      if(!isFinite(minX)) return;

      const bw = (maxX - minX) + pad*2;
      const bh = (maxY - minY) + pad*2;

      const sx = rect.width / bw;
      const sy = rect.height / bh;
      const s = clamp(Math.min(sx, sy), 0.35, 2.5);

      CAM[key].scale = s;
      CAM[key].tx = pad - minX*s + (rect.width - bw*s)/2;
      CAM[key].ty = pad - minY*s + (rect.height - bh*s)/2;

      applyCam(key);
    }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    /* =========================
       NODE DRAG (in blueprint mode)
    ========================= */
    function startNodeDrag(e, key, nodeId){
      if(CAM[key].mode !== 'blueprint') return;

      drag.active = true;
      drag.key = key;
      drag.nodeId = nodeId;
      // continue: NODE DRAG
      const st = STUDIO[key];
      const nodeEl = st.nodesHost.querySelector(`.node[data-id="${nodeId}"]`);
      if(!nodeEl) return;

      nodeEl.classList.add('active');
      nodeEl.style.cursor = 'grabbing';

      const startX = e.clientX;
      const startY = e.clientY;

      // position initiale
      const initLeft = parseFloat(nodeEl.style.left || nodeEl.offsetLeft);
      const initTop  = parseFloat(nodeEl.style.top  || nodeEl.offsetTop);

      // on stocke delta (en coordonn√©es √©cran), puis on convertit par scale
      drag.dx = startX;
      drag.dy = startY;
      drag.initLeft = initLeft;
      drag.initTop  = initTop;

      // emp√™cher pan pendant drag
      drag.panning = false;

      // stop s√©lection texte
      e.preventDefault();
      e.stopPropagation();

      window.addEventListener('mousemove', onNodeDragMove);
      window.addEventListener('mouseup', onNodeDragEnd);

      function onNodeDragMove(ev){
        if(!drag.active || drag.key !== key || drag.nodeId !== nodeId) return;
        const c = CAM[key];

        const ddx = (ev.clientX - drag.dx) / c.scale;
        const ddy = (ev.clientY - drag.dy) / c.scale;

        const newLeft = clamp(drag.initLeft + ddx, 0, 2200-220);
        const newTop  = clamp(drag.initTop  + ddy, 0, 1400-80);

        nodeEl.style.left = `${newLeft}px`;
        nodeEl.style.top  = `${newTop}px`;

        // redraw edges
        drawEdges(key);
      }

      function onNodeDragEnd(){
        window.removeEventListener('mousemove', onNodeDragMove);
        window.removeEventListener('mouseup', onNodeDragEnd);

        drag.active = false;
        drag.key = null;
        drag.nodeId = null;

        nodeEl.classList.remove('active');
        nodeEl.style.cursor = 'grab';

        toast('info','Blueprint','Node d√©plac√© (d√©mo).');
        audit('Admin', WORKFLOWS[key].module, 'NODE_MOVE', `node=${nodeId}`, 'INFO');
        pushLog(WORKFLOWS[key].module,'Blueprint','Node moved','OK');
      }
    }

    /* =========================
       TERMINAL (console n8n-like)
    ========================= */
    function termLog(key, msg, level='INFO'){
      const wf = WORKFLOWS[key];
      const box = document.getElementById(wf.termId);
      if(!box) return;

      const t = new Date().toLocaleTimeString();
      const lvlColor = level==='OK' ? 'color:#51cf66'
                     : level==='WARN'? 'color:#ffd43b'
                     : level==='FAIL'? 'color:#ff6b6b'
                     : 'color:#cbd5e1';

      const line = document.createElement('div');
      line.className = 'term-line';
      line.innerHTML = `<div class="term-time">[${t}]</div><div class="term-text" style="${lvlColor}">${escapeHtml(msg)}</div>`;
      box.appendChild(line);
      box.scrollTop = box.scrollHeight;

      // keep terminal lean
      while(box.children.length > 60) box.removeChild(box.firstChild);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    /* =========================
       WORKFLOW RUN / WALKTHROUGH
       - highlights nodes
       - updates badges
       - pushes logs + audit
       - computes KPIs per module
    ========================= */
    const RUNSTATE = { running:false, timer:null, idx:0, key:null };

    function runWorkflow(key){
      ensureStudio(key);
      const wf = WORKFLOWS[key];

      if(CAM[key].mode !== 'blueprint'){
        toast('warn','Workflow', 'Passe en mode Blueprint pour ex√©cuter.');
        return;
      }
      if(RUNSTATE.running){
        toast('warn','Workflow','Un run est d√©j√† en cours.');
        return;
      }

      RUNSTATE.running = true;
      RUNSTATE.idx = 0;
      RUNSTATE.key = key;

      termLog(key, `‚ñ∂ RUN START ‚Äî ${wf.module}`, 'OK');
      pushLog(wf.module,'Run','Start','OK');
      audit('Admin', wf.module, 'RUN_START', 'walkthrough', 'INFO');

      // reset badges
      resetNodeBadges(key);

      const stepDelay = (ms)=> ms / wfSpeed;

      const steps = wf.run.slice(); // copy

      const tick = ()=>{
        if(!RUNSTATE.running || RUNSTATE.key !== key) return;

        if(RUNSTATE.idx >= steps.length){
          // finish
          RUNSTATE.running = false;
          termLog(key, `‚ñ† RUN END ‚Äî ${wf.module}`, 'OK');
          pushLog(wf.module,'Run','End','OK');
          audit('Admin', wf.module, 'RUN_END', 'walkthrough', 'INFO');

          // compute KPIs demo
          computeWfKPIs(key);

          toast('ok','Workflow', `${wf.module}: ex√©cution termin√©e.`);
          return;
        }

        const step = steps[RUNSTATE.idx++];
        const nodeEl = STUDIO[key].nodesHost.querySelector(`.node[data-id="${step.node}"]`);

        highlightNode(key, step.node, 'RUNNING');
        termLog(key, step.log, 'INFO');
        pushLog(wf.module,'Step',`${step.node} ${step.log}`,'OK');

        // small random warnings for realism
        if(Math.random() < 0.12){
          markNode(key, step.node, 'WARN');
          termLog(key, `‚ö† WARN: v√©rification suppl√©mentaire / champ optionnel d√©tect√©`, 'WARN');
          pushLog(wf.module,'Warn','Optional field flagged','WARN');
          audit('Admin', wf.module, 'STEP_WARN', `node=${step.node}`, 'WARN');
        } else {
          markNode(key, step.node, 'OK');
        }

        // auto focus camera on node
        if(nodeEl) centerOnNode(key, nodeEl);

        RUNSTATE.timer = setTimeout(tick, stepDelay(800));
      };

      tick();
    }

    function resetNodeBadges(key){
      const st = STUDIO[key];
      const nodes = st.nodesHost.querySelectorAll('.node');
      nodes.forEach(n=>{
        n.classList.remove('ok','warn','fail','active');
        const b = n.querySelector('.badge');
        if(b){
          b.className = 'badge idle';
          b.textContent = 'IDLE';
        }
      });
      drawEdges(key);
    }

    function highlightNode(key, nodeId, label='RUN'){
      const st = STUDIO[key];
      const n = st.nodesHost.querySelector(`.node[data-id="${nodeId}"]`);
      if(!n) return;
      st.nodesHost.querySelectorAll('.node').forEach(x=>x.classList.remove('active'));
      n.classList.add('active');
      const b = n.querySelector('.badge');
      if(b){
        b.className = 'badge info';
        b.textContent = label;
      }
    }

    function markNode(key, nodeId, status){
      const st = STUDIO[key];
      const n = st.nodesHost.querySelector(`.node[data-id="${nodeId}"]`);
      if(!n) return;

      n.classList.remove('ok','warn','fail');
      const b = n.querySelector('.badge');

      if(status==='OK'){
        n.classList.add('ok');
        if(b){ b.className='badge ok'; b.textContent='OK'; }
      } else if(status==='WARN'){
        n.classList.add('warn');
        if(b){ b.className='badge warn'; b.textContent='WARN'; }
      } else {
        n.classList.add('fail');
        if(b){ b.className='badge fail'; b.textContent='FAIL'; }
      }
    }

    function centerOnNode(key, nodeEl){
      // smooth-ish camera move
      const st = STUDIO[key];
      const vpRect = st.vp.getBoundingClientRect();
      const c = CAM[key];

      const nx = nodeEl.offsetLeft + nodeEl.offsetWidth/2;
      const ny = nodeEl.offsetTop + nodeEl.offsetHeight/2;

      // desired screen center
      const cx = vpRect.width/2;
      const cy = vpRect.height/2;

      // current translate targets
      const targetTx = cx - nx*c.scale;
      const targetTy = cy - ny*c.scale;

      // lerp
      c.tx = c.tx + (targetTx - c.tx) * 0.18;
      c.ty = c.ty + (targetTy - c.ty) * 0.18;

      applyCam(key);
    }

    function computeWfKPIs(key){
      const wf = WORKFLOWS[key];

      if(key==='design'){
        const cycle = rand(9, 16) + ' j';
        const nogo = rand(6, 18) + '%';
        const tickets = rand(1, 8) + '/sem';
        const handoff = rand(92, 99) + '%';
        wf.kpiSet({cycle, nogo, tickets, handoff});
        termLog(key, `KPI: cycle=${cycle}, no-go=${nogo}, tickets=${tickets}, handoff=${handoff}`, 'OK');
      }
      if(key==='cat'){
        const sync = rand(96, 99) + '%';
        const dup = rand(8, 46) + ' /j';
        const dlq = rand(0, 7) + ' items';
        const publish = rand(6, 20) + ' min';
        wf.kpiSet({sync, dup, dlq, publish});
        termLog(key, `KPI: sync=${sync}, dup=${dup}, dlq=${dlq}, publish=${publish}`, 'OK');
      }
      if(key==='mark'){
        const conv = rand(420, 1320);
        const ctr = (2 + Math.random()*3).toFixed(1) + '%';
        const roas = (2 + Math.random()*5).toFixed(1) + 'x';
        const pacing = rand(88, 104) + '%';
        wf.kpiSet({conv: fmt(conv), ctr, roas, pacing});
        termLog(key, `KPI: conv=${fmt(conv)}, ctr=${ctr}, roas=${roas}, pacing=${pacing}`, 'OK');
      }
      if(key==='care'){
        const ttr = rand(3, 14) + ' h';
        const breach = rand(0, 7) + '%';
        const auto = rand(35, 72) + '%';
        const rma = rand(18, 60) + ' /j';
        wf.kpiSet({ttr, breach, auto, rma});
        termLog(key, `KPI: ttr=${ttr}, breach=${breach}, auto=${auto}, rma=${rma}`, 'OK');
      }

      pushLog(wf.module,'KPI','Computed','OK');
      audit('Admin', wf.module, 'KPI_COMPUTE', 'demo computed', 'INFO');
    }

    /* =========================
       FULLSCREEN MODAL (reuse same viewport)
       - clone the studio viewport into modal
       - keep pan/zoom working
    ========================= */
    function wfFullscreen(key){
      ensureStudio(key);
      const wf = WORKFLOWS[key];
      const modal = document.getElementById('fsModal');
      const title = document.getElementById('fsTitle');
      const content = document.getElementById('fsContent');

      title.textContent = `${wf.module} ‚Äî Fullscreen`;
      content.innerHTML = '';

      // clone viewport container
      const clone = STUDIO[key].vp.cloneNode(true);
      clone.id = `vpFS_${key}`;

      // IMPORTANT: rebind events on the cloned viewport
      content.appendChild(clone);
      modal.classList.add('active');

      // rebuild studio for cloned view (new "temporary" studio)
      const tempKey = `${key}_fs`;
      const tempWorld = clone.querySelector('.wf-world');
      const tempSvg   = clone.querySelector('svg.wf-svg');
      const tempNodes = clone.querySelector('.wf-nodes');

      STUDIO[tempKey] = {vp:clone, world:tempWorld, svg:tempSvg, nodesHost:tempNodes};

      // copy camera state
      CAM[tempKey] = {...CAM[key]};

      // bind interactions
      clone.addEventListener('wheel', (e)=> onWheelFS(e, tempKey), {passive:false});
      clone.addEventListener('mousedown', (e)=> onPanStartFS(e, tempKey));
      window.addEventListener('mousemove', (e)=> onPanMoveFS(e, tempKey));
      window.addEventListener('mouseup', ()=> onPanEndFS(tempKey));

      applyCam(tempKey);

      toast('info','Fullscreen', `${wf.module} en plein √©cran.`);
      audit('Admin', wf.module, 'FULLSCREEN', 'open', 'INFO');
    }

    function fsClose(){
      const modal = document.getElementById('fsModal');
      const content = document.getElementById('fsContent');
      modal.classList.remove('active');

      // cleanup temp studios
      Object.keys(STUDIO).filter(k=>k.endsWith('_fs')).forEach(k=>{
        delete STUDIO[k];
        delete CAM[k];
      });
      content.innerHTML = '';
    }

    // FS handlers (same logic but independent key)
    function onWheelFS(e, key){ onWheel(e, key); }
    function onPanStartFS(e, key){
      if(e.target.closest('.node')) return;
      const st = STUDIO[key];
      if(!st) return;
      drag.panning = true; drag.key = key; drag.px = e.clientX; drag.py = e.clientY;
      st.vp.classList.add('grabbing');
    }
    function onPanMoveFS(e, key){ onPanMove(e, key); }
    function onPanEndFS(key){
      if(!drag.panning || drag.key !== key) return;
      drag.panning = false; drag.key = null;
      if(STUDIO[key]) STUDIO[key].vp.classList.remove('grabbing');
    }

    /* =========================
       OPS: demo checks + auto audit
    ========================= */
    function runOpsChecks(){
      toast('info','OPS','Ex√©cution contr√¥les (d√©mo)‚Ä¶');
      audit('Admin','OPS','CHECKS_START','security+gdpr+availability','INFO');
      pushLog('OPS','Checks','Start','OK');

      setTimeout(()=>{
        pushLog('OPS','Checks','GDPR consent OK','OK');
        audit('Admin','OPS','CHECK','gdpr=ok','INFO');
      }, 450);

      setTimeout(()=>{
        pushLog('OPS','Checks','RBAC policy OK','OK');
        audit('Admin','OPS','CHECK','rbac=ok','INFO');
      }, 950);

      setTimeout(()=>{
        pushLog('OPS','Checks','DLQ size low','OK');
        audit('Admin','OPS','CHECK','dlq=low','INFO');
        toast('ok','OPS','Contr√¥les OK.');
      }, 1450);
    }

    /* =========================
       INIT: build studios once (safe)
    ========================= */
    // Prepare studios lazily when user visits, but we can init first for demo smoothness:
    // ensureStudio('design'); ensureStudio('cat'); ensureStudio('mark'); ensureStudio('care');

    // Make ops section feel alive
    audit('System','OPS','BOOT','titan-v8.workflow-suite.pro','INFO');

    // Optional: bind ESC to close fullscreen
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        const modal = document.getElementById('fsModal');
        if(modal.classList.contains('active')) fsClose();
      }
    });
  </script>
</body>
</html>


